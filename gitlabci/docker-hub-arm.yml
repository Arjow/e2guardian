docker-hub-build-arm:
  stage: Docker-hub-build
  image: docker:19.03.8-dind 
  tags:
    - arm
  before_script:
    - docker login -u "$DOCKER_HUB_USER" -p "$DOCKER_HUB_TOKEN" $DOCKER_HUB_REGISTRY
  script:
    - cd $CI_PROJECT_DIR && cp gitlabci/docker-ci/Dockerfile-arm ./Dockerfile
    - docker build --build-arg E2_VERSION="$CI_COMMIT_BRANCH" --pull -t $CONTAINER_BUILD_NOPROD_NAME_ARM .
    - docker push $CONTAINER_BUILD_NOPROD_NAME_ARM

variables:
  CONTAINER_PROD_IMAGE: $HUB_REGISTRY_IMAGE:$CI_COMMIT_BRANCH
  CONTAINER_BUILD_NOPROD_NAME_ARM: $HUB_REGISTRY_IMAGE:build-noprod-arm

variables:
  CONTAINER_PROD_IMAGE: $HUB_REGISTRY_IMAGE:$CI_COMMIT_BRANCH
  CONTAINER_BUILD_NOPROD_NAME_AMD64: $HUB_REGISTRY_IMAGE:build-noprod-amd64

docker-hub-test:
  image: $CONTAINER_BUILD_NOPROD_NAME_ARM
  stage: Docker-hub-test
  script:
    - e2guardian -N
    - apt update && apt install -y curl
    - export https_proxy=http://localhost:8080 && curl -k https://www.google.fr

push-docker-hub-arm:
  stage: Docker-hub-pushtag
  tags:
    - arm
  image: docker:dind
  before_script:
    - docker login -u "$DOCKER_HUB_USER" -p "$DOCKER_HUB_TOKEN" $DOCKER_HUB_REGISTRY
  script:
    - docker pull $CONTAINER_BUILD_NOPROD_NAME_ARM
    - docker tag $CONTAINER_BUILD_NOPROD_NAME $CONTAINER_PROD_IMAGE:arm64
    - docker push $CONTAINER_PROD_IMAGE_ARM:arm64
